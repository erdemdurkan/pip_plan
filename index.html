<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Stok Plan Dönüştürücü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <input type="file" id="file1" />
  <input type="file" id="file2" />
  <button onclick="convert()">Dönüştür</button>

  <script>
    function toText(val) {
      return String(val || '').trim().toUpperCase();
    }

    async function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          resolve(workbook);
        };
        reader.onerror = err => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    function convert() {
      const file1 = document.getElementById('file1').files[0];
      const file2 = document.getElementById('file2').files[0];

      if (!file1 || !file2) {
        alert('Lütfen her iki dosyayı da seçin!');
        return;
      }

      Promise.all([readFile(file1), readFile(file2)]).then(([stokWB, planWB]) => {
        const stokSheet = XLSX.utils.sheet_to_json(stokWB.Sheets[stokWB.SheetNames[0]]);
        const planSheet = XLSX.utils.sheet_to_json(planWB.Sheets[planWB.SheetNames[0]], { defval: "" });

        const stoklar = {};
        stokSheet.forEach(row => {
          const nokta = toText(row["SORGULAMA_NOKTASI"]);
          if (nokta === "MONTAJ" || nokta === "AYAR") {
            const kod = toText(row["SASI_KODU_3"]);
            const adet = Number(row["ADET"]) || 0;
            stoklar[kod] = (stoklar[kod] || 0) + adet;
          }
        });

        const updated = planSheet.map(row => ({ ...row }));

        Object.entries(stoklar).forEach(([kod3, adet]) => {
          const ilgili = updated
            .map((r, i) => ({ ...r, _idx: i }))
            .filter(r => toText(Object.values(r)[4]).startsWith(kod3) && Number(r["PLAN"]) > 0);

          for (const row of ilgili) {
            const index = row._idx;
            const planAdet = Number(updated[index]["PLAN"]) || 0;
            if (adet <= 0) break;
            if (planAdet <= adet) {
              adet -= planAdet;
              updated[index]["PLAN"] = 0;
            } else {
              updated[index]["PLAN"] = planAdet - adet;
              adet = 0;
            }
          }
        });

        const header = Object.keys(updated[0]);
        const aoa = [header];
        updated.forEach(row => {
          aoa.push(header.map(h => row[h]));
        });

        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const range = XLSX.utils.decode_range(ws['!ref']);

        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = ws[cellRef];
            if (!cell.s) cell.s = {};
            cell.s.font = { sz: 8 }; // Font boyutu 8

            cell.s.border = {
              top: { style: "thin", color: { rgb: "000000" } },
              bottom: { style: "thin", color: { rgb: "000000" } },
              left: { style: "thin", color: { rgb: "000000" } },
              right: { style: "thin", color: { rgb: "000000" } },
            };

            if (C === 4) {
              cell.s.fill = { fgColor: { rgb: "CCFFFF" } };
            }
            if (C === 9) {
              cell.s.fill = { fgColor: { rgb: "CCFFCC" } };
            }
          }
        }

        const wbOut = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wbOut, ws, "q1");
        XLSX.writeFile(wbOut, "Guncel_PLAN.xlsx");
      });
    }
  </script>
</body>

</html>
